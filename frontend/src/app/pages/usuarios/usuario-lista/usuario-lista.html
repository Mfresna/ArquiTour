<div id="global">
  <div id="contenedor-usuarios">

    <!-- AREA DE FILTRADO -->
    <div id="panel-izq">
      <h3 class="titulo">Usuarios</h3>
      <div id="panel-filtros">

        <form [formGroup]="filtroForm" (submit)="cargarUsuarios()" class="form-filtros">

          <!-- NOMBRE -->
          <fieldset class="campo">
            <label for="nombre">Nombre</label>
            <input 
              id="nombre" 
              type="text" 
              formControlName="nombre" 
              placeholder="Buscar por nombre..." 
              (blur)="cargarUsuarios()"
              (keyup.enter)="cargarUsuarios()"/>
          </fieldset>

          <!-- APELLIDO -->
          <fieldset class="campo">
            <label for="apellido">Apellido</label>
            <input 
              id="apellido" 
              type="text" 
              formControlName="apellido" 
              placeholder="Buscar por apellido..."
              (blur)="cargarUsuarios()"
              (keyup.enter)="cargarUsuarios()"/>
          </fieldset>

          <!-- EMAIL -->
          <fieldset class="campo">
            <label for="email">Email</label>
            <input 
              id="email" 
              type="email" 
              formControlName="email" 
              placeholder="Buscar por email..."
              (blur)="cargarUsuarios()"
              (keyup.enter)="cargarUsuarios()"/>
          </fieldset>

          <!-- ESTADO -->
          <fieldset class="campo">
            <label for="estado">Estado</label>
            <select 
              id="estado" 
              formControlName="isActivo" 
              (change)="cargarUsuarios()">
                <option value="">-- Todos --</option>
                <option [ngValue]="true">Activos</option>
                <option [ngValue]="false">Desactivados</option>
            </select>
          </fieldset>

          <!-- ROL -->
          <fieldset class="campo">
            <label for="rol">Rol</label>
            <select 
              id="rol"
              formControlName="rol" 
              (change)="cargarUsuarios()">
              <option value="">-- Todos --</option>
                @for (r of roles; track r){
                  @if(r !== 'ROLE_USUARIO'){
                    <option [value]="r">
                      {{ RolModelDescripcion[r] || r }}
                    </option>
                  }
                }
            </select>
          </fieldset>

          <div id = "botonera">
            <button id="buscar" type="submit">Buscar</button>
            <button id="limpiar" type="button" (click)="limpiarFiltros()">Limpiar</button>
          </div>
          
        </form>

      </div>
    </div>

    <!-- LISTADO DE USUARIOS -->
    <div id="panel-der">
      <div id="panel-scroll">
        <!-- ACA -->
        <div id="contenedor-lista">
          @if (usuarios) {
            <ul id="lista-usuarios" >
              @for (u of usuarios; track u.id ?? $index) {
                <li>

                  <div id="informacion" 
                    class="contenido-usuario"
                    (click)="irDetalleUsuario(u.id!)"
                    [class.usr-hab]="u.activo"
                    [class.usr-deshab]="!u.activo">
                    <!-- informacion -->
                    <div class="informacion-usuario">
                      <div class="nombre-usuario">
                        <h4>{{u.nombre + ' ' + u.apellido}}</h4>
                      </div>
                      <div class="datos-usuario">
                        <p>{{u.email}}</p>
                        <p class="rol-usuario">{{getDescripcionRol(u.roles)}}</p>
                      </div>
                    </div>

                  </div>

                  <!-- botonera de accion -->
                  <div class="botonera">

                    <div id="btn-rol" class="btn-etiqueta-detalle">
                      <span 
                        class="material-symbols-rounded btn-rol" 
                        (click)="abrirSelectorRoles($event, u)"
                        [class.zoom]="!mostrarSelectorRoles">admin_panel_settings</span>
                      
                        @if(!mostrarSelectorRoles){
                          <div class="etiqueta-detalle">Gestionar Roles</div>
                        }
                      
                        @if (mostrarSelectorRoles && usuarioSeleccionado?.id === u.id) {
                          <app-select-roles
                            [id]="u.id!"
                            [rolesAnteriores]="getRolesEnumValidos(u.roles)"
                            (cambiosRoles)="cambiosDeRoles($event)"
                            (cerrado)="cerrarSelector()">
                          </app-select-roles>
                        }
                    </div>

                    <div id="btn-estado" class="btn-etiqueta-detalle">
                      <span class="material-symbols-rounded "
                        [class.inhabilitado]="!u.activo"
                        [class.zoom]="!mostrarSelectorRoles"
                        (click)="CambiarEstadoCuenta(u)">person_off</span>

                      @if(u.activo && !mostrarSelectorRoles){
                        <div class="etiqueta-detalle">Desactivar</div>
                      }@else if(!mostrarSelectorRoles) {
                        <div class="etiqueta-detalle">Activar</div>
                      }

                    </div>
                  </div>
                </li>
              }
            </ul>
          } @else {
            <p class="vacio">No se encontraron usuarios con los filtros seleccionados.</p>
          }
        </div>
        

      </div>
    </div>
  </div>

</div>

<app-esperando-modal 
  [isVisible]="spinerVisible" 
  [mensaje]="spinerMensaje"
/>
<app-mensaje-modal
  [isVisible]="modalVisible"
  [titulo]="modalTitulo"
  [mensaje]="modalMensaje"
  [tipo]="modalTipo"
  [conIcon]="true"
  tipoContenido="texto"
  [mostrarCerrar]="true"
  [mostrarBotonAceptar]="true"
  [mostrarBotonCancelar]="false"
  textoBotonAceptar="Aceptar"
  (aceptar)="onModalAceptar()"
  (cerrado)="onModalCerrado()"
></app-mensaje-modal>